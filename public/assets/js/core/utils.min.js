(function(){var app=this,mDialogTpl=['<div class="m-dialog" style="">','<div class="m-content">','<div class="m-txt"></div>',"</div>",'<div class="m-footer">','<button class="m-btn" data-role="ok"></button>','<button class="m-btn" data-role="cancel"></button>',"</div>"+"</div>"].join(""),utils={mNotice:function(message,iconType,timeout){var ctx=this,message=message||"",iconType=iconType||"info",tmpl='<div class="mNotice">'+'<i class="'+iconType+'"></i>'+"<span>"+message+"</span>"+"</div>",timeout,ntc;if("error"===iconType){ctx.hint(message);return}if("success"===iconType){timeout=timeout?timeout:800}else{timeout=timeout?timeout:3e3}ntc=$(tmpl).appendTo($("body"));ctx.centerElement(ntc);setTimeout(function(){ntc.remove()},timeout);return ntc},hint:function(message,callback){var opts={dialogClass:"m-alert-dialog",content:message,ok:callback,okClass:"m-btn-danger m-one-btn",btnCancel:false};this.dialog(opts)},dialog:function(options){var ctx=this;setTimeout(function(){ctx._dialog(options)},5)},_dialog:function(options){var opts=options||{},timeStamp=(new Date).valueOf(),dialogClass=opts.dialogClass||"",autoClose=opts.autoClose||false,dId=opts.id||"m_dialog_"+timeStamp,maskId="m_modal_"+timeStamp,modal=opts.modal===false?false:true,btnOk=opts.btnOk===false?false:true,btnCancel=opts.btnCancel===false?false:true,okText=opts.okText||"确认",cancelText=opts.cancelText||"取消",okClass=opts.okClass||"m-btn-success",cancelClass=opts.cancelClass||"",content=opts.content||"",$body=$("body"),$dialog,$ok,$cancel;$(".m-dialog-modal, .m-dialog").remove();if(modal){$('<div class="m-modal m-dialog-modal" id="'+maskId+'"></div>').appendTo($body)}$dialog=$(mDialogTpl).appendTo($body);$dialog.addClass(dialogClass).attr("id",dId);$dialog.find(".m-txt").html(content);$ok=$dialog.find('[data-role="ok"]');$cancel=$dialog.find('[data-role="cancel"]');if(btnOk){$ok.text(okText);okClass&&$ok.addClass(okClass);$ok.bind("click",function(){opts.ok&&opts.ok();$(".m-dialog-modal, .m-dialog").remove()})}else{$ok.remove()}if(btnCancel){$cancel.text(cancelText);cancelClass&&$cancel.addClass(cancelClass);$cancel.bind("click",function(){opts.cancel&&opts.cancel();$(".m-dialog-modal, .m-dialog").remove()})}else{$cancel.remove()}if(!btnOk&&!btnCancel){$dialog.find(".m-footer").remove()}var clientWidth=jQuery(window).width();var clientHeight=jQuery(window).height();var dialogLeft=(clientWidth-$dialog.outerWidth())/2;var dialogTop=(clientHeight-$dialog.height())*.382;dialogLeft=opts.left||dialogLeft;dialogTop=opts.top||dialogTop;$dialog.css({top:dialogTop+"px",left:dialogLeft+"px"});if(autoClose){autoClose=autoClose>1?autoClose:1e3;setTimeout(function(){jQuery("#"+dId).fadeOut("slow",function(){jQuery("#"+maskId).hide();jQuery("#"+maskId).remove();jQuery("#"+dId).hide();jQuery("#"+dId).remove();if(typeof opts.closeCallback=="function"){opts.closeCallback()}})},autoClose)}},centerElement:function(el,width,height){var ctx=this,win=ctx.getClient(),winHeight=win.h,winWidth=win.w,element=el.jquery?el[0]:el,_width=width||element.offsetWidth,height=height||element.offsetHeight,top,left;left=Math.floor((winWidth-_width)*.5);if(width){element.style.width=width+"px"}element.style.position="fixed";element.style.left=left+"px";top=Math.floor((winHeight-height)*.45);element.style.top=top+"px"},getClient:function(e){var w,h;if(e){w=e.clientWidth;h=e.clientHeight}else{w=window.innerWidth?window.innerWidth:document.documentElement&&document.documentElement.clientWidth?document.documentElement.clientWidth:document.body.offsetWidth;h=window.innerHeight?window.innerHeight:document.documentElement&&document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.offsetHeight}return{w:w,h:h}},getFileExt:function(name){var name=name||"",ext="",arr=name.split(".");ext=arr[arr.length-1];return ext.toLowerCase()},imageView:function(){!function($){var touch={},touchTimeout,tapTimeout,swipeTimeout,longTapTimeout,longTapDelay=750,gesture;function swipeDirection(x1,x2,y1,y2){return Math.abs(x1-x2)>=Math.abs(y1-y2)?x1-x2>0?"Left":"Right":y1-y2>0?"Up":"Down"}function longTap(){longTapTimeout=null;if(touch.last){touch.el.trigger("longTap");touch={}}}function cancelLongTap(){if(longTapTimeout)clearTimeout(longTapTimeout);longTapTimeout=null}function cancelAll(){if(touchTimeout)clearTimeout(touchTimeout);if(tapTimeout)clearTimeout(tapTimeout);if(swipeTimeout)clearTimeout(swipeTimeout);if(longTapTimeout)clearTimeout(longTapTimeout);touchTimeout=tapTimeout=swipeTimeout=longTapTimeout=null;touch={}}function isPrimaryTouch(event){return(event.pointerType=="touch"||event.pointerType==event.MSPOINTER_TYPE_TOUCH)&&event.isPrimary}function isPointerEventType(e,type){return e.type=="pointer"+type||e.type.toLowerCase()=="mspointer"+type}$(document).ready(function(){var now,delta,deltaX=0,deltaY=0,firstTouch,_isPointerType;if("MSGesture"in window){gesture=new MSGesture;gesture.target=document.body}$(document).bind("MSGestureEnd",function(e){var swipeDirectionFromVelocity=e.velocityX>1?"Right":e.velocityX<-1?"Left":e.velocityY>1?"Down":e.velocityY<-1?"Up":null;if(swipeDirectionFromVelocity){touch.el.trigger("swipe");touch.el.trigger("swipe"+swipeDirectionFromVelocity)}}).on("touchstart MSPointerDown pointerdown",function(e){if((_isPointerType=isPointerEventType(e,"down"))&&!isPrimaryTouch(e))return;firstTouch=_isPointerType?e:e.originalEvent.touches[0];if(e.originalEvent.touches&&e.originalEvent.touches.length===1&&touch.x2){touch.x2=undefined;touch.y2=undefined}now=Date.now();delta=now-(touch.last||now);touch.el=$("tagName"in firstTouch.target?firstTouch.target:firstTouch.target.parentNode);touchTimeout&&clearTimeout(touchTimeout);touch.x1=firstTouch.pageX;touch.y1=firstTouch.pageY;if(delta>0&&delta<=250)touch.isDoubleTap=true;touch.last=now;longTapTimeout=setTimeout(longTap,longTapDelay);if(gesture&&_isPointerType)gesture.addPointer(e.pointerId)}).on("touchmove MSPointerMove pointermove",function(e){if((_isPointerType=isPointerEventType(e,"move"))&&!isPrimaryTouch(e))return;firstTouch=_isPointerType?e:e.originalEvent.touches[0];cancelLongTap();touch.x2=firstTouch.pageX;touch.y2=firstTouch.pageY;deltaX+=Math.abs(touch.x1-touch.x2);deltaY+=Math.abs(touch.y1-touch.y2)}).on("touchend MSPointerUp pointerup",function(e){if((_isPointerType=isPointerEventType(e,"up"))&&!isPrimaryTouch(e))return;cancelLongTap();if(touch.x2&&Math.abs(touch.x1-touch.x2)>30||touch.y2&&Math.abs(touch.y1-touch.y2)>30)swipeTimeout=setTimeout(function(){touch.el.trigger("swipe");touch.el.trigger("swipe"+swipeDirection(touch.x1,touch.x2,touch.y1,touch.y2));touch={}},0);else if("last"in touch)if(deltaX<30&&deltaY<30){tapTimeout=setTimeout(function(){var event=$.Event("tap");event.cancelTouch=cancelAll;touch.el.trigger(event);if(touch.isDoubleTap){if(touch.el)touch.el.trigger("doubleTap");touch={}}else{touchTimeout=setTimeout(function(){touchTimeout=null;if(touch.el)touch.el.trigger("singleTap");touch={}},250)}},0)}else{touch={}}deltaX=deltaY=0}).on("touchcancel MSPointerCancel pointercancel",cancelAll);$(window).on("scroll",cancelAll)});["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","singleTap","longTap"].forEach(function(eventName){$.fn[eventName]=function(callback){return this.on(eventName,callback)}})}(window.jQuery);$.os=$.os||{};var tmpl=function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('<ul class="pv-inner" style="line-height:');_p(data.height);__p.push('px;">');for(var i=0;i<data.photos.length;i++){__p.push('<li class="pv-img" style="width:');_p(data.width);__p.push("px;height:");_p(data.height);__p.push('px;"></li>')}__p.push('</ul>    <span class="ui-loading white" id="J_loading"><div class="loadInco"><span class="blockG" id="rotateG_01"></span><span class="blockG" id="rotateG_02"></span><span class="blockG" id="rotateG_03"></span><span class="blockG" id="rotateG_04"></span><span class="blockG" id="rotateG_05"></span><span class="blockG" id="rotateG_06"></span><span class="blockG" id="rotateG_07"></span><span class="blockG" id="rotateG_08"></span></div></span><p class="counts"><span class="value" id="J_index">');_p(data.index+1);__p.push("/");_p(data.photos.length);__p.push("</span></p>");return __p.join("")};var ImageView={photos:null,index:0,el:null,config:null,lastContainerScroll:0,zoom:1,advancedSupport:false,lastTapDate:0,init:function(photos,index,config){var self=this;index=+index||0;this.config=$.extend({fade:true},config);this.lastContainerScroll=document.body.scrollTop;if($.os.iphone||$.os.android&&parseFloat($.os.version)>=4){this.advancedSupport=true}if(this.config.count){this.photos=new Array(this.config.count);var len=photos.length,start=this.config.idx_space||0;for(var i=start;i<start+len;i++){this.photos[i]=photos[i-start]}this.index=start+index}else{this.photos=photos||[];this.index=index||0}setTimeout(function(){self.clearStatus();self.render(true);self.bind();self.changeIndex(self.index,true)},0)},clearStatus:function(){this.width=Math.max(window.innerWidth,document.body.clientWidth);this.height=window.innerHeight;this.zoom=1;this.zoomX=0;this.zoomY=0},render:function(first){if(first){$('<div id="imageView" class="slide-view" style="display:none;">').appendTo($("body"))}this.el=$("#imageView");this.el.html(tmpl({photos:this.photos,index:this.index,width:this.width,height:this.height}));if(first){this.el.css({opacity:0,height:this.height+"px",top:window.scrollY+"px"}).show().animate({opacity:1},300)}},topFix:function(){if(!ImageView.el)return;ImageView.el.css("top",window.scrollY+"px")},bind:function(){var self=this;this.unbind();$(window).on("scroll",this.topFix);this.el.on("touchstart touchmove touchend touchcancel",function(e){e.touches=e.originalEvent?e.originalEvent.touches:null;self.handleEvent(e)});this.el.on("click",function(e){e.preventDefault();var now=new Date;if(now-this.lastTapDate<500){return}this.lastTapDate=now;self.onSingleTap(e)}).on("doubleTap",function(e){e.preventDefault();self.onDoubleTap(e)});this._resize=function(){self.resize()};"onorientationchange"in window?window.addEventListener("orientationchange",this._resize,false):window.addEventListener("resize",this._resize,false)},unbind:function(){this.el.off();$(window).off("scroll",this.topFix);"onorientationchange"in window?window.removeEventListener("orientationchange",this._resize,false):window.removeEventListener("resize",this._resize,false)},handleEvent:function(e){switch(e.type){case"touchstart":this.onTouchStart(e);break;case"touchmove":e.preventDefault();this.onTouchMove(e);break;case"touchcancel":case"touchend":this.onTouchEnd(e);break;case"orientationchange":case"resize":this.resize(e);break}},onSingleTap:function(e){this.close(e)},getDist:function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2),2)},doubleZoomOrg:1,doubleDistOrg:1,isDoubleZoom:false,onTouchStart:function(e){if(this.advancedSupport&&e.touches&&e.touches.length>=2){var img=this.getImg();img.style.webkitTransitionDuration="0";this.isDoubleZoom=true;this.doubleZoomOrg=this.zoom;this.doubleDistOrg=this.getDist(e.touches[0].pageX,e.touches[0].pageY,e.touches[1].pageX,e.touches[1].pageY);return}e=e.touches?e.touches[0]:e;this.isDoubleZoom=false;this.startX=e.pageX;this.startY=e.pageY;this.orgX=e.pageX;this.orgY=e.pageY;this.hasMoved=false;if(this.zoom!=1){this.zoomX=this.zoomX||0;this.zoomY=this.zoomY||0;var img=this.getImg();if(img){img.style.webkitTransitionDuration="0"}this.drag=true}else{if(this.photos.length==1){return}this.el.find(".pv-inner").css("transitionDuration","0");this.transX=-this.index*this.width;this.slide=true}},onTouchMove:function(e){if(this.advancedSupport&&e.touches&&e.touches.length>=2){var newDist=this.getDist(e.touches[0].pageX,e.touches[0].pageY,e.touches[1].pageX,e.touches[1].pageY);this.zoom=newDist*this.doubleZoomOrg/this.doubleDistOrg;var img=this.getImg();img.style.webkitTransitionDuration="0";if(this.zoom<1){this.zoom=1;this.zoomX=0;this.zoomY=0;img.style.webkitTransitionDuration="200ms"}else if(this.zoom>this.getScale(img)*2){this.zoom=this.getScale(img)*2}img.style.webkitTransform="scale("+this.zoom+") translate("+this.zoomX+"px,"+this.zoomY+"px)";return}if(this.isDoubleZoom){return}e=e.touches?e.touches[0]:e;if(!this.hasMoved&&(Math.abs(e.pageX-this.orgX)>5||Math.abs(e.pageY-this.orgY)>5)){this.hasMoved=true}if(this.zoom!=1){var deltaX=(e.pageX-this.startX)/this.zoom;var deltaY=(e.pageY-this.startY)/this.zoom;this.startX=e.pageX;this.startY=e.pageY;var img=this.getImg();var newWidth=img.width*this.zoom,newHeight=img.height*this.zoom;var borderX=(newWidth-this.width)/2/this.zoom,borderY=(newHeight-this.height)/2/this.zoom;if(borderX>=0){if(this.zoomX<-borderX||this.zoomX>borderX){deltaX/=3}}if(borderY>0){if(this.zoomY<-borderY||this.zoomY>borderY){deltaY/=3}}this.zoomX+=deltaX;this.zoomY+=deltaY;if(this.photos.length==1&&newWidth<this.width){this.zoomX=0}else if(newHeight<this.height){this.zoomY=0}img.style.webkitTransform="scale("+this.zoom+") translate("+this.zoomX+"px,"+this.zoomY+"px)"}else{if(!this.slide){return}var deltaX=e.pageX-this.startX;if(this.transX>0||this.transX<-this.width*(this.photos.length-1)){deltaX/=4}this.transX=-this.index*this.width+deltaX;this.el.find(".pv-inner").css("transform","translateX("+this.transX+"px)")}},onTouchEnd:function(e){if(this.isDoubleZoom){return}if(!this.hasMoved){return}if(this.zoom!=1){if(!this.drag){return}var img=this.getImg();img.style.webkitTransitionDuration="200ms";var newWidth=img.width*this.zoom,newHeight=img.height*this.zoom;var borderX=(newWidth-this.width)/2/this.zoom,borderY=(newHeight-this.height)/2/this.zoom;var len=this.photos.length;if(len>1&&borderX>=0){var updateDelta=0;var switchDelta=this.width/6;if(this.zoomX<-borderX-switchDelta/this.zoom&&this.index<len-1){updateDelta=1}else if(this.zoomX>borderX+switchDelta/this.zoom&&this.index>0){updateDelta=-1}if(updateDelta!=0){this.scaleDown(img);this.changeIndex(this.index+updateDelta);return}}if(borderX>=0){if(this.zoomX<-borderX){this.zoomX=-borderX}else if(this.zoomX>borderX){this.zoomX=borderX}}if(borderY>0){if(this.zoomY<-borderY){this.zoomY=-borderY}else if(this.zoomY>borderY){this.zoomY=borderY}}if(this.isLongPic(img)&&Math.abs(this.zoomX)<10){img.style.webkitTransform="scale("+this.zoom+") translate(0px,"+this.zoomY+"px)";return}else{img.style.webkitTransform="scale("+this.zoom+") translate("+this.zoomX+"px,"+this.zoomY+"px)"}this.drag=false}else{if(!this.slide){return}var deltaX=this.transX- -this.index*this.width;var updateDelta=0;if(deltaX>50){updateDelta=-1}else if(deltaX<-50){updateDelta=1}this.changeIndex(this.index+updateDelta);this.slide=false}},getImg:function(index){var img=this.el.find("li").eq(index||this.index).find("img");if(img.size()==1){return img[0]}else{return null}},getScale:function(img){if(this.isLongPic(img)){return this.width/img.width}else{var h=img.naturalHeight,w=img.naturalWidth;var hScale=h/img.height,wScale=w/img.width;if(hScale>wScale){return wScale}else{return hScale}}},onDoubleTap:function(e){var now=new Date;if(now-this.lastTapDate<500){return}this.lastTapDate=now;var img=this.getImg();if(!img){return}if(this.zoom!=1){this.scaleDown(img)}else{this.scaleUp(img)}this.afterZoom(img)},scaleUp:function(img){var scale=this.getScale(img);if(scale>1){img.style.webkitTransform="scale("+scale+")";img.style.webkitTransition="200ms"}this.zoom=scale;this.afterZoom(img)},scaleDown:function(img){this.zoom=1;this.zoomX=0;this.zoomY=0;this.doubleDistOrg=1;this.doubleZoomOrg=1;img.style.webkitTransform="";this.afterZoom(img)},afterZoom:function(img){if(this.zoom>1&&this.isLongPic(img)){var newHeight=img.height*this.zoom;var borderY=(newHeight-this.height)/2/this.zoom;if(borderY>0){this.zoomY=borderY;img.style.webkitTransform="scale("+this.zoom+") translate(0px,"+borderY+"px)"}}},isLongPic:function(img){return img.height/img.width>=3.5},resizeTimer:null,resize:function(e){clearTimeout(this.resizeTimer);var self=this;this.resizeTimer=setTimeout(function(){document.body.style.minHeight=window.innerHeight+1+"px";if(self.zoom!=1){self.scaleDown(self.getImg())}self.clearStatus();self.render();self.el.height(self.height).css("top",window.scrollY+"px");self.changeIndex(self.index,true)},600)},changeIndex:function(index,force){if(this.indexChangeLock){return}if(index<0){index=0}else if(index>=this.photos.length){index=this.photos.length-1}var changed=this.index!=index;this.index=index;var inner=this.el.find(".pv-inner");inner.css({transitionDuration:force?"0":"200ms",transform:"translateX(-"+index*this.width+"px)"});var li=inner.find("li").eq(index);var imgs=li.find("img");var self=this;if(!imgs.size()){this.el.find("#J_loading").show();if(typeof this.photos[index]!="undefined"){var img=new Image;img.onload=function(){if(self.el==null){return}img.onload=null;self.el.find("#J_loading").hide();img.style.webkitTransform="";img.style.opacity="";if(self.isLongPic(img)){setTimeout(function(){self.scaleUp(img)},0)}};img.ontimeout=img.onerror=function(){li.html('<i style="color:white;">This image is broken, try again later.</i>');self.el.find("#J_loading").hide()};if(this.advancedSupport){img.style.webkitBackfaceVisibility="hidden"}img.style.opacity="0";img.src=this.getImgUrl(index);li.html("").append(img);if(this.config.onRequestMore&&this.index>0&&typeof this.photos[index-1]=="undefined"){this.config.onRequestMore(this.photos[index],-1,index)}else if(this.config.onRequestMore&&this.index<this.photos.length-1&&typeof this.photos[this.index+1]=="undefined"){this.config.onRequestMore(this.photos[index],1,index)}this.preload(index-1);this.preload(index+1)}else{this.indexChangeLock=true}}if(changed||force){this.el.find("#J_index").html(index+1+"/"+this.photos.length);this.config.onIndexChange&&this.config.onIndexChange(img,this.photos,index)}setTimeout(function(){self.memoryClear()},0)},memoryClear:function(){var li=this.el.find(".pv-img");var i=this.index-10;while(i>=0){if(li.eq(i).html()=="")break;li.eq(i).html("");i--}i=this.index+10;while(i<li.size()){if(li.eq(i).html()=="")break;li.eq(i).html("");i++}},getImgUrl:function(index,useOrg){if(index<0||index>=this.photos.length||!this.photos[index]){return""}return this.photos[index]},preload:function(index){if(index<0||index>=this.photos.length||!this.getImg(index)){return}var url=this.getImgUrl(index);if(url){var img=new Image;img.src=url}},update:function(photos,index){if(index<this.photos.length){var len=photos.length;for(var i=index;i<index+len;i++){this.photos[i]=photos[i-index]}if(this.indexChangeLock){this.indexChangeLock=false;this.changeIndex(this.index)}}},destroy:function(){if(this.el){var self=this;this.unbind();this.el.animate({opacity:0},300,"linear",function(){if(self.el){self.el.html("").remove();self.el=null}});this.config.onClose&&this.config.onClose(this.img,this.photos,this.index)}},close:function(){this.destroy()}};return ImageView},previewPhoto:function(e){var ctx=utils,photoTypes=["jpg","png","gif","bmp","jpeg"],$photoItem=$(e.currentTarget),$photo=$photoItem.find("img"),$list=$photoItem.closest('[data-role="photoList"]'),url=$photoItem.attr("data-original")||$photo.attr("data-original")||"",getFileExt=ctx.getFileExt,ext=getFileExt(url),current=url.indexOf("/assets")>-1?url:url+"!medium.640",index,pics=[];if(!~photoTypes.indexOf(ext)){return}if($list.length===0){url&&pics.push(current)}else{$list.find('[data-role="photoItem"]').each(function(_,item){var url=$(item).attr("data-original")||$(item).find("img").attr("data-original")||"",ext=getFileExt(url),thumb=url.indexOf("/assets")>-1?url:url+"!medium.640";photoTypes.indexOf(ext)>-1&&pics.push(thumb)})}index=$photoItem.index();ctx.imageView().init(pics,index)},bindPreview:function(options){var ctx=this,opts=options||{},wrapper=opts.wrapper||"body",item=opts.item||'[data-role="photoItem"]';$(wrapper).off("click",item,ctx.previewPhoto);$(wrapper).on("click",item,ctx.previewPhoto)},classifyAttachment:function(list){var ctx=utils,list=list||[],videoTypes=["3gp","mov","mp4","ogg","avi"],photoTypes=["jpg","png","gif","bmp","jpeg"],audioTypes=["mp3","wav"],docTypes=["doc","xls","ppt","docx","xlsx","pptx","pdf"],result={videos:[],photos:[],audios:[],docs:[],others:[]},item,url,ext;for(var i=list.length-1;i>=0;i--){item=list[i];url=item.url||"";ext=ctx.getFileExt(url);if(videoTypes.indexOf(ext)>-1){result.videos.unshift(item)}else if(photoTypes.indexOf(ext)>-1){result.photos.unshift(item)}else if(audioTypes.indexOf(ext)>-1){result.audios.unshift(item)}else if(docTypes.indexOf(ext)>-1){result.docs.unshift(item)}else{result.others.unshift(item)}}return result},formatDate:function(timeStamp){var now=(new Date).valueOf();var result="";var delta=(now-timeStamp)/1e3;if(delta<60){result="刚刚"}else if(delta<60*60){result=Math.floor(delta/60)+"分钟前"}else if(delta<24*60*60){result=Math.floor(delta/(60*60))+"小时前"}else if(delta<30*24*60*60){result=Math.floor(delta/(24*60*60))+"天前"}else if(delta<12*30*24*60*60){result=Math.floor(delta/(30*24*60*60))+"个月前"}else if(delta>=12*30*24*60*60){result=Math.floor(delta/(12*30*24*60*60))+"年前"}return result},play:function(){var videoTpl='<video id="{id}" class="" controls preload="auto" width="240" height="150"><source src="{source}" /></video>',audioTpl='<audio id="{id}" src="{source}" controls preload="true" width="240">您的浏览器不支持 audio 标签</audio>',Media={video:function(options){var opts=options||{},videoOpts=$.extend(true,{},opts),id=opts.id||"video_"+(new Date).valueOf(),source=opts.source||"",ext=source.split(".")[1],type="video/"+ext,$place=typeof opts.place==="string"?$("#"+opts.place):opts.place,parentWidth=$place.closest(".m-video-item").width(),width,html=videoTpl;html=html.replace("{id}",id);html=html.replace("{source}",source);$place.html(html);delete videoOpts["id"];delete videoOpts["source"];delete videoOpts["place"];setTimeout(function(){$("#"+id).mediaelementplayer({})},1)},audio:function(options){var opts=options||{},audioOpts=$.extend(true,{},opts),id=opts.id||"audio_"+(new Date).valueOf(),source=opts.source||"",ext=source.split(".")[1],type="audio/"+ext,$place=typeof opts.place==="string"?$("#"+opts.place):opts.place,parentWidth=$place.closest(".m-audio-item").width(),width,html=audioTpl;html=html.replace("{id}",id);html=html.replace("{source}",source);$place.html(html);setTimeout(function(){$("#"+id).mediaelementplayer({})},1)}},bindShowMedia=function(e){var $poster=$(e.currentTarget);var $parent=$poster.closest(".m-media-player");var $show=$parent.find('[data-role="show"]');var $play=$parent.find('[data-role="play"]');var type=$parent.attr("data-type");var source=$parent.attr("data-source");if("video"===type){$poster.hide();$show.show();Media.video({type:type,source:source,place:$play})}else if("audio"===type){$poster.hide();$show.show();Media.audio({type:type,source:source,place:$play})}},bindHideMedia=function(e){var $remove=$(e.currentTarget);var $parent=$remove.closest(".m-media-player");var $poster=$parent.find('[data-role="poster"]');var $show=$parent.find('[data-role="show"]');var $play=$parent.find('[data-role="play"]');$poster.show();$show.hide();$play.html("")};$("body").off("click",'.m-media-player [data-role="poster"]',bindShowMedia);$("body").on("click",'.m-media-player [data-role="poster"]',bindShowMedia);$("body").off("click",'.m-media-player [data-role="remove"]',bindHideMedia);$("body").on("click",'.m-media-player [data-role="remove"]',bindHideMedia)}},centerElement=function(el,width,height){var win=utils.getClient(),winHeight=win.h,winWidth=win.w,element=el.jquery?el[0]:el,_width=width||element.offsetWidth,height=height||element.offsetHeight,top,left;left=Math.floor((winWidth-_width)*.5);if(width){element.style.width=width+"px"}element.style.position="fixed";element.style.left=left+"px";top=Math.floor((winHeight-height)*.45);element.style.top=top+"px"},mLoading={success:function(){var notice="成功了",timeout=1e3,callback,$dom;if(arguments.length===3){notice=arguments[0];timeout=arguments[1];callback=arguments[2]}else if(arguments.length===2){notice=arguments[0];timeout=typeof arguments[1]=="number"?arguments[1]:timeout;callback=typeof arguments[1]=="function"?arguments[1]:null}else if(arguments.length==1){notice=typeof arguments[0]=="string"?arguments[0]:notice;callback=typeof arguments[0]=="function"?arguments[0]:null}var tmpl='<div id="mLoading" role="success"><div class="lbk"></div><div class="lcont">'+notice+"</div></div>";$("#mLoading").remove();$dom=$(tmpl).appendTo($("body"));centerElement($("#mLoading"),146,146);setTimeout(function(){$dom.remove();callback&&callback()},timeout)},show:function(notice,options){var notice=notice||"正在加载...",options=options||{},tmpl='<div id="mLoading"><div class="lbk"></div><div class="lcont">'+notice+"</div></div>";if($("#mLoading").length>0){$("#mLoading .lcont").text(notice)}else{$("body").append(tmpl);centerElement($("#mLoading"),146,146)}},hide:function(){$("#mLoading").remove()}};app.factory("mNotice",function(){return utils.mNotice.bind(utils)});app.factory("imgPreview",function(){return utils.bindPreview.bind(utils)});app.factory("classifyAttachment",function(){return utils.classifyAttachment});app.factory("formatDate",function(){return utils.formatDate});app.factory("play",function(){return utils.play});app.factory("mLoading",function(){return mLoading});app.factory("tools",function(){var isImg=function(ext){return!!~["bmp","gif","jpg","jpeg","png"].indexOf(ext)},getExt=function(url){var arr=url.split(".");return arr[arr.length-1].toLowerCase()},setListIcon=function(list){list.length&&angular.forEach(list,function(item){item.config&&item.config.length&&angular.forEach(item.config,function(data){if(!this.url&&isImg(getExt(data.url||data))){this.url=data.url+"!square.150"}},item);if(!item.url&&item.content){var img=/<img[^>]+>/g.exec(item.content);img&&(item.url=$(img[0])[0].src.replace("medium.640","square.150"))}item.url=item.url?item.url:"assets/img/school/news/p"+Math.ceil(Math.random()*21)+".jpg";item.style={"background-image":"url("+item.url+")"};item.content=item.content.replace(/<[^>]+>/g,"").replace("&nbsp","");item.content=item.content.length>46?item.content.slice(0,46)+"...":item.content})};return{setListIcon:setListIcon}});app.factory("scroll",function(){return{initScroll:function(ulSelector,isFlip,containerSelector,pageOnClass){var cSelector=containerSelector||"body";var isFlip=isFlip||false;var pageOnClass=pageOnClass||"on";var x,y,endX,endY,offsetX,offsetY,objLeft,left=0,tabIndex=0;var ulObj=jQuery(ulSelector);var minX=0;jQuery(cSelector).on("touchstart",ulSelector,function(e){jQuery(this).css({position:"relative"});x=endX=e.originalEvent.touches[0].pageX;y=endY=e.originalEvent.touches[0].pageY;objLeft=left});jQuery(cSelector).on("touchmove",ulSelector,function(e){endX=e.originalEvent.touches[0].pageX;endY=e.originalEvent.touches[0].pageY;offsetX=endX-x;offsetY=endY-y;if(Math.abs(offsetY)<Math.abs(offsetX)){if(e.preventDefault){e.preventDefault()}}else{return true}var obj=jQuery(this);left=objLeft+parseInt(offsetX);if(left>0){left=0;offsetX=0;offsetY=0}if(!isFlip){minX=0;obj.find("li").each(function(i,e){minX+=jQuery(e).width()});var parentObj=obj.parent();minX=minX-parentObj.width()+parentObj.offset().left;minX*=-1}else{var liObj=obj.find("li");minX=-1*liObj.width()*(liObj.length-1)}if(left<=minX){left=minX;offsetX=0;offsetY=0}jQuery(this).css("left",left)});jQuery(cSelector).on("touchend",ulSelector,function(e){if(!isFlip){objLeft=left;document.ontouchstart=function(e){return true}}else{changeTab(this.id,-1,offsetX);offsetX=0}});var changeTab=function(ulId,index,offsetX){var pObj=jQuery("#"+ulId+"_page a");var len=pObj.length;if(index<0){if(offsetX>10){index=tabIndex-1}else if(offsetX<-10){index=tabIndex+1}else{index=tabIndex}}if(index>len-1||index<0){return}var pageWidth=jQuery("#"+ulId+" li").width();var le=-1*pageWidth*index;var le_px=le+"px";left=le;jQuery("#"+ulId).stop().animate({left:le_px},100,function(){left=le});pObj.removeClass(pageOnClass);pObj.eq(index).addClass(pageOnClass);tabIndex=index}}}});app.factory("emotion",["scroll",function(libScroll){var ICON={"闭嘴":"e107.gif",NO:"e188.gif","跳跳":"e192.gif","怄火":"e194.gif","转圈":"e195.gif","磕头":"e196.gif","回头":"e197.gif","跳绳":"e198.gif","闭嘴":"e107.gif","呲牙":"e113.gif","调皮":"e112.gif","流汗":"e127.gif","偷笑":"e120.gif","再见":"e139.gif","敲打":"e138.gif","擦汗":"e140.gif","猪头":"e162.gif","玫瑰":"e163.gif","流泪":"e105.gif","大哭":"e109.gif","嘘..":"e133.gif","酷":"e116.gif","抓狂":"e118.gif","委屈":"e149.gif","便便":"e174.gif","炸弹":"e170.gif","菜刀":"e155.gif","可爱":"e121.gif","色":"e102.gif","害羞":"e106.gif","得意":"e104.gif","吐":"e119.gif","微笑":"e100.gif","发怒":"e111.gif","尴尬":"e110.gif","惊恐":"e126.gif","冷汗":"e117.gif","爱心":"e166.gif","示爱":"e165.gif","白眼":"e122.gif","傲慢":"e123.gif","难过":"e115.gif","惊讶":"e114.gif","疑问":"e132.gif","睡":"e108.gif","亲亲":"e152.gif","憨笑":"e128.gif","爱情":"e190.gif","衰":"e136.gif","撇嘴":"e101.gif","阴险":"e151.gif","奋斗":"e130.gif","发呆":"e103.gif","右哼哼":"e146.gif","拥抱":"e178.gif","坏笑":"e144.gif","飞吻":"e191.gif","鄙视":"e148.gif","晕":"e134.gif","大兵":"e129.gif","可怜":"e154.gif","强":"e179.gif","弱":"e180.gif","握手":"e181.gif","胜利":"e182.gif","抱拳":"e183.gif","凋谢":"e164.gif","饭":"e161.gif","蛋糕":"e168.gif","西瓜":"e156.gif","啤酒":"e157.gif","瓢虫":"e173.gif","勾引":"e184.gif",OK:"e189.gif","爱你":"e187.gif","咖啡":"e160.gif","月亮":"e175.gif","刀":"e171.gif","发抖":"e193.gif","差劲":"e186.gif","拳头":"e185.gif","心碎":"e167.gif","太阳":"e176.gif","礼物":"e177.gif","足球":"e172.gif","骷髅":"e137.gif","挥手":"e199.gif","闪电":"e169.gif","饥饿":"e124.gif","困":"e125.gif","咒骂":"e131.gif","折磨":"e135.gif","抠鼻":"e141.gif","鼓掌":"e142.gif","溴大了":"e143.gif","左哼哼":"e145.gif","哈欠":"e147.gif","快哭了":"e150.gif","吓":"e153.gif","篮球":"e158.gif","乒乓":"e159.gif"};var tpl='<div class="expreBox">'+'<ul class="expreCon expreConNew" id="exp_emo0">'+'<li class="bg1" style="background-position: 50% 50%;">'+'<a href="javascript:void(0);" title="微笑"></a>'+'<a href="javascript:void(0);" title="撇嘴"></a>'+'<a href="javascript:void(0);" title="色"></a>'+'<a href="javascript:void(0);" title="发呆"></a>'+'<a href="javascript:void(0);" title="得意"></a>'+'<a href="javascript:void(0);" title="流泪"></a>'+'<a href="javascript:void(0);" title="害羞"></a>'+'<a href="javascript:void(0);" title="闭嘴"></a>'+'<a href="javascript:void(0);" title="睡"></a>'+'<a href="javascript:void(0);" title="大哭"></a>'+'<a href="javascript:void(0);" title="尴尬"></a>'+'<a href="javascript:void(0);" title="发怒"></a>'+'<a href="javascript:void(0);" title="调皮"></a>'+'<a href="javascript:void(0);" title="呲牙"></a>'+'<a href="javascript:void(0);" title="惊讶"></a>'+'<a href="javascript:void(0);" title="难过"></a>'+'<a href="javascript:void(0);" title="酷"></a>'+'<a href="javascript:void(0);" title="冷汗"></a>'+'<a href="javascript:void(0);" title="抓狂"></a>'+'<a href="javascript:void(0);" title="吐"></a>'+'<a href="javascript:void(0);"></a>'+"</li>"+"</ul>"+"</div>"+'<p class="pNumCon" id="exp_emo0_page">'+'<a href="javascript:void(0);" class=" pNumOn  pNum "></a>'+"</p>";return{init:function(options){var opts=options||{},$container=$(opts.container),$textarea=opts.textarea?$(opts.textarea):$("#content"),$select=opts.select?$(opts.select):$(".expreSelect");$container.html(tpl);libScroll.initScroll(".expreBox ul",true,"body","pNumOn");$select.bind("click",function(){var target=$(this);target.toggleClass("expreSelectOn");if(target.hasClass("expreSelectOn")){$container.show()}else{$container.hide()}});$container.find(".expreCon li a").each(function(i){jQuery(this).on("click",function(){var title=jQuery(this).attr("title");if($textarea){var content=$textarea.val();if(!title){if(content&&content.lastIndexOf("]")==content.length-1){var LeftIndex=content.lastIndexOf("[");content=content.substring(0,LeftIndex)}else{content=content.substring(0,content.length-1)}}else{content=content+"["+title+"]"}$textarea.val(content)}})})},hide:function(options){var opts=options||{},$container=$(opts.container),$select=opts.select?$(opts.select):$(".expreSelect");$select.removeClass("expreSelectOn");$container.hide()},replace_em:function(str){var str=str||"",prefix="/assets/img/news/emotion/",qqFace="/assets/img/news/emotion1/";
str=str.replace(/\</g,"&lt;");str=str.replace(/\>/g,"&gt;");str=str.replace(/\n/g,"<br/>");str=str.replace(/\[em_([0-9]*)\]/g,'<img src="'+qqFace+'$1.gif" border="0" />');return str.replace(/\[(.*?)\]/gim,function(match,key){var url;if(typeof ICON[key]!="undefined"){url=prefix+ICON[key];return'<img src="'+url+'" border="0" />'}return match})}}}])}).call(angular.module("m.utils",[]));