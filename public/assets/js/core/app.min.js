"use strict";(function($){$.fn.insertContent=function(newValue,t){var $t=$(this)[0];if(document.selection){var sel=document.selection.createRange();sel.text=newValue;sel.moveStart("character",-l);var wee=sel.text.length;if(arguments.length==2){var l=$t.value.length;sel.moveEnd("character",wee+t);t<=0?sel.moveStart("character",wee-2*t-newValue.length):sel.moveStart("character",wee-t-newValue.length)}$t.blur()}else if($t.selectionStart||$t.selectionStart=="0"){var startPos=$t.selectionStart;var endPos=$t.selectionEnd;var scrollTop=$t.scrollTop;$t.value=$t.value.substring(0,startPos)+newValue+$t.value.substring(endPos,$t.value.length);$t.selectionStart=startPos+newValue.length;$t.selectionEnd=startPos+newValue.length;$t.scrollTop=scrollTop;if(arguments.length==2){$t.setSelectionRange(startPos-t,$t.selectionEnd+t)}$t.blur()}else{$t.value+=newValue;$t.blur()}}})(jQuery);(function(app){var defaults={redirect:"school/public",rootPath:location.protocol+"//"+location.host,timestamp:Date.parse(new Date)/1e3,automask:false,autotips:false,app:{code:"",dir:"",dashboard:"",schoolmanager:"",styles:[],scripts:[],modules:[]},map:[{path:"",view:"",viewUrl:null,styles:null,scripts:null,modules:null}],menu:[{code:"",name:"",icon:""}],service:{},eachpath:function(list,ext){angular.forEach(list,function(path){this.push(defaults.extpath(path,ext))},list=[]);return list},extpath:function(path,ext){var filedir=defaults.rootPath+"/assets/"+(ext==="html"?"views":ext)+"/"+defaults.app.dir,fileext="."+ext,nofirst=!/(^http:\/\/)|(^https:\/\/)|(^\/)/.test(path),noparam=!new RegExp("\\."+ext+"\\?","i").test(path),nullext=!new RegExp("(\\."+ext+"$)|(\\."+ext+"\\?)","i").test(path);if(nofirst)path=filedir+path;if(nullext)path=path+fileext;if(nofirst&&noparam)path=path+"?t="+defaults.timestamp;return path},browser:function(ua){var ret={},weixin=ua.match(/MicroMessenger\/([\d.]+)/);weixin&&(ret.weixin=parseFloat(weixin[1]));return ret}(navigator.userAgent),os:function(ua){var ret={},android=ua.match(/(?:Android);?[\s\/]+([\d.]+)?/),ios=ua.match(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/);android&&(ret.android=parseFloat(android[1]));ios&&(ret.ios=parseFloat(ios[1].replace(/_/g,".")));return ret}(navigator.userAgent)},mimetypes=function(){return{js:"application/x-javascript",css:"text/css",less:"text/css",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",png:"image/png",bmp:"image/bmp",swf:"application/x-shockwave-flash",pdf:"application/pdf","7z":"application/x-7z-compressed",rar:"application/x-rar-compressed",zip:"application/zip,application/x-zip-compressed",doc:"application/msword",docx:"application/msword",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.ms-powerpoint",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",txt:"text/plain",mp3:"audio/mpeg",wma:"audio/x-ms-wma",rm:"application/vnd.rn-realmedia",rmvb:"application/vnd.rn-realmedia",ra:"audio/x-pn-realaudio",mid:"audio/midi",wav:"audio/x-wav",md:"text/plain",avi:"video/x-msvideo",mp4:"video/mp4",m3u:"audio/x-mpegurl",m4a:"audio/mp4a-latm",m4b:"audio/mp4a-latm",m4p:"audio/mp4a-latm",m4u:"video/vnd.mpegurl",m4v:"video/x-m4v","3gp":"video/3gpp",ts:"text/texmacs",wmv:"video/x-ms-wmv",mkv:"video/x-matroska",mov:"video/quicktime"}}(),getMimeTypes=function(extensions){extensions=extensions.split(",");angular.forEach(extensions,function(key){this.push(mimetypes[key]||"*")},extensions=[]);return extensions.join()};IGrow.Config&&angular.forEach(defaults,function(item,name,config){if((config=IGrow.Config[name])&&item instanceof Array){defaults[name]=config}else if(typeof item==="object"){angular.extend(item,config)}else if(config!==undefined){defaults[name]=config}});app.config(["$animateProvider","$compileProvider","$controllerProvider","$filterProvider","$httpProvider","$locationProvider","$routeProvider","$provide",function($animateProvider,$compileProvider,$controllerProvider,$filterProvider,$httpProvider,$locationProvider,$routeProvider,$provide){$locationProvider.html5Mode(true);$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|javascript):/);$httpProvider.interceptors.push(["$q","tips","viewMask",function($q,tips,viewMask){return{request:function(request){if(request.url&&/\/api\/1.1b\//i.test(request.url)&&request.method){var reset=function(data){angular.forEach(["automask","autotips"],function(key){request[key]=data[key]===undefined?defaults[key]:data[key];delete data[key]});delete data._api_action;if(IGrow.User){if(IGrow.User.schoolid&&!/\/api\/1.1b\/school\/(student|teacher|parent|people)\/get/i.test(request.url)){data.schoolid=data.schoolid||IGrow.User.schoolid}if(IGrow.User.semesterid&&!/\/api\/1.1b\/auth\//i.test(request.url)){data.semesterid=data.semesterid||IGrow.User.semesterid}}return data};if(request.method.toUpperCase()==="GET"){request.params=reset(request.params||{})}else{request.data=reset(request.data||{});request.headers["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";request.transformRequest=[function(data){return angular.isObject(data)?$.param(angular.forEach(data,function(item,key){data[key]=angular.isArray(item)||angular.isObject(item)?JSON.stringify(item):item})):data}]}request.automask&&viewMask.open();request.url=decodeURIComponent(request.url)}return request},requestError:function(request){return $q.reject(request)},response:function(response){if(response.config){response.config.automask&&viewMask.close();response.data.message&&(response.config.autotips===true||response.config.autotips===1)&&tips.success(response.data.message)}return response},responseError:function(response){if(response.config){response.config.automask&&viewMask.close();response.data.message&&(response.config.autotips===true||response.config.autotips===2)&&tips.error(response.data.message)}if(response.data.code=="10020002"){location.href="http://auth.igrow.cn/auth/login?go="+encodeURIComponent(location.href)}return $q.reject(response)}}}]);$provide.factory("loadScript",["$q",function($q){var cache={};return function(path,callback){var defer=$q.defer(),loadList=[],promiseList=[];angular.forEach(path instanceof Array?path:[path],function(url,defer){defer=cache[url]||$q.defer();promiseList.push(defer.promise);if(!cache[url]){cache[url]=defer;loadList.push(url)}});(function toload(index,url,element){if(url=loadList[index]){element=document.createElement("script");element[document.addEventListener?"onload":"onreadystatechange"]=function(_,isAbort){if(isAbort||!element.readyState||/loaded|complete/.test(element.readyState)){document.body.removeChild(element);cache[url].resolve();toload(index+1)}};element.onerror=function(){cache[url].reject();toload(index+1)};element.src=url;document.body.appendChild(element)}})(0);$q.all(promiseList).then(function(){angular.isFunction(callback)&&setTimeout(callback);defer.resolve()},defer.reject);return defer.promise}}]);$provide.factory("loadStyle",["$q",function($q){var cache={};return function(path){var $ua=navigator.userAgent,callback=angular.isFunction(arguments[1])?arguments[1]:arguments[2],preload=typeof arguments[1]==="boolean"?arguments[1]:arguments[2];angular.forEach(path instanceof Array?path:[path],function(url,defer,element){defer=cache[url]||$q.defer();this.push(defer.promise);if(!cache[url]){element=document.createElement("link");element.rel="stylesheet";if(preload){cache[url]=defer}else{element.className="loader-stylesheet"}if(/(?:Android);?[\s\/]+([\d.]+)?/i.test($ua)||/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/i.test($ua)){(function poll(count,loaded){if(/webkit/i.test($ua)){if(element.sheet){loaded=true}}else if(element.sheet){try{if(element.sheet.cssRules){loaded=true}}catch(ex){if(ex.name==="SecurityError"||ex.code===1e3){loaded=true}}}if(loaded||count>=200){defer.resolve()}else{setTimeout(function(){poll(count+1)},10)}})(0)}else{element[document.addEventListener?"onload":"onreadystatechange"]=function(_,isAbort){if(isAbort||!element.readyState||/loaded|complete/.test(element.readyState)){defer.resolve()}}}element.onerror=defer.reject;element.href=url;(document.head||document.getElementsByTagName("head")[0]).appendChild(element)}},path=[]);var defer=$q.defer();$q.all(path).then(function(){angular.isFunction(callback)&&setTimeout(callback);defer.resolve()},defer.reject);return defer.promise}}]);$provide.factory("moduleInjector",["$injector","$log",function($injector,$log){var $injected={},invokeQueue=[],runBlocks=[],providers={$animateProvider:$animateProvider,$compileProvider:$compileProvider,$controllerProvider:$controllerProvider,$filterProvider:$filterProvider,$provide:$provide};return function(modules){modules&&angular.forEach(modules instanceof Array?modules:[modules],function(item,module){try{if(!$injected[item]&&(module=angular.module(item))){invokeQueue=invokeQueue.concat(module._invokeQueue);runBlocks=runBlocks.concat(module._runBlocks);$injected[item]=true}}catch(ex){if(ex.message){ex.message+=" from "+item;$log.error(ex.message)}throw ex}});angular.forEach(invokeQueue,function(item,provide){try{item.length>2&&providers.hasOwnProperty(item[0])&&(provide=providers[item[0]])&&provide[item[1]].apply(provide,item[2])}catch(ex){if(ex.message){ex.message+=" from "+JSON.stringify(item);$log.error(ex.message)}throw ex}});angular.forEach(runBlocks,function(item){$injector.invoke(item)});invokeQueue.length=0;runBlocks.length=0}}]);$provide.factory("routeApply",["$q","$location","moduleInjector","loadScript",function($q,$location,moduleInjector,loadScript){var defer={};return function(routes){angular.forEach(routes,function(route){if(route.view||route.viewUrl){angular.forEach(route.scripts?route.scripts instanceof Array?route.scripts:[route.scripts]:[],function(path){this.push(defaults.extpath(path,"js"))},route.scripts=[]);angular.forEach(route.path instanceof Array?route.path:[route.path],function(path){this.when("/m/"+path,{template:route.viewUrl?undefined:route.view,templateUrl:route.viewUrl?defaults.extpath(route.viewUrl,"html"):undefined,resolve:{promise:function(){if(!defer[path]){if(!IGrow.User&&!/^\/m\/school|aboutSchool\/.+/.test($location.url())){setTimeout(function(){defer[path].reject();$location.path("/m/"+defaults.redirect);$location.replace()})}else{$("body>section").css({visibility:"hidden"});loadScript(route.scripts,function(){moduleInjector(route.modules);defer[path].resolve();setTimeout(function(){$("body>section").css({visibility:"visible"})})})}}return(defer[path]=defer[path]||$q.defer()).promise}}})},$routeProvider)}});$routeProvider.otherwise({redirectTo:"/m/"+defaults.redirect})}}]);$provide.service("$api",["$resource",function($resource){var fullUrl=function(url,bool){return(/(^http:\/\/)|(^https:\/\/)|(^\/)/.test(url)?url:location.protocol+"//"+location.host+"/api/1.1b/"+url)+(bool?"/:_api_action":"")};this.$apply=function(items,clear){clear&&angular.forEach(this,function(item,name){if(name!=="$apply"){delete this[name]}},this);angular.forEach(items,function(item,name){if(item instanceof Array){var url=item[0],paramDefaults=item[1],actions=item[2],options=item[3];if(url){actions=angular.forEach(angular.extend({get:{method:"GET"},list:{method:"GET"},search:{method:"GET"},set:{method:"POST"},create:{method:"POST"},update:{method:"POST"},remove:{method:"POST"},"delete":{method:"POST"}},actions),function(action,name){action=action||{};if(action.url){action.url=fullUrl(action.url)}action.method=action.method||"GET";action.params=angular.extend(action.url?{}:{_api_action:name==="remove"?"delete":name},action.params)});this[name]=$resource(fullUrl(url,true),paramDefaults,actions,options)}}},this);return this}}]);$provide.factory("tips",function(){var zIndex=1050,dialog,dialogId="dialog"+Date.parse(new Date)/1e3,tip=function(content,config){if(content){config=angular.extend({clas:"modal-primary",icon:"fa fa-question-circle",timeout:2e3},config);var timer,modal,modalId="modal"+(new Date).getTime(),remove=function(){modal.animate({marginTop:0,opacity:0},200,function(){$(this).remove();config.callback instanceof Function&&setTimeout(config.callback);!dialog.children(".modal-content").length&&dialog.parent().remove()})};if(!document.getElementById(dialogId)){$("body>section>div[ng-view]").children().each(function(i){if(!!parseInt($(this).css("zIndex")))zIndex=parseInt($(this).css("zIndex"))+1});$("body>section>div[ng-view]").append('<div class="modal modal-tips" style="z-index:'+zIndex+'" id="'+dialogId+'"><div class="modal-mask"></div><div class="modal-dialog"></div></div>');dialog=$("#"+dialogId+">.modal-dialog")}dialog.append(['<div id="'+modalId+'" class="modal-content '+config.clas+'">','<i class="'+config.icon+'"></i>','<a href="javascript:void(0)" class="iconfont icon-close"></a>','<div class="modal-body">',content,"</div>","</div>"].join(""));modal=$("#"+modalId).animate({marginTop:15,opacity:1},200).mouseenter(function(){timer&&clearTimeout(timer)}).mouseleave(function(){if(config.timeout)timer=setTimeout(remove,config.timeout)});modal.children("a").click(remove);if(config.timeout)timer=setTimeout(remove,config.timeout)}return tip};tip.extend=function(){var $this=this,conf,config=arguments[0]||[],i=0;if(!(config instanceof Array)){config=[config]}for(;i<config.length;i++){(conf=config[i])&&typeof conf==="object"&&function(conf){$this[conf.name]=function(content,config){if(typeof config==="number"){config={timeout:config}}if(typeof config==="function"){config={callback:config}}return tip(content,angular.extend(angular.copy(conf),config))}}(conf)}return $this};return tip.extend([{name:"alert",clas:"modal-primary",icon:"iconfont icon-questionfill"},{name:"success",clas:"modal-success",icon:"iconfont icon-roundcheck"},{name:"info",clas:"modal-info",icon:"iconfont icon-infofill"},{name:"warning",clas:"modal-warning",icon:"iconfont icon-warnfill"},{name:"error",clas:"modal-danger",icon:"iconfont icon-infofill",timeout:0}])});$provide.service("viewMask",function(){var count=0,viewmask=$("body>div.view-mask").hide(),mask=function(callback,bool,closeAll){if(bool){count++;!$(".modal-backdrop").length&&viewmask.show()}else{if(closeAll){count=0}else{count--}!count&&viewmask.hide()}callback instanceof Function&&setTimeout(callback)};this.open=function(){mask(arguments[0],true)};this.close=function(){var callback=arguments[0],closeAll=arguments[1];if(!(callback instanceof Function)){callback=null;closeAll=arguments[0]}mask(callback,false,closeAll)}})}]);app.directive("weixinUploader",["$api","$timeout",function($api,$timeout){}]);app.directive("webUploader",["$timeout","loadScript","viewMask",function($timeout,loadScript,viewMask){return{restrict:"A",link:function(scope,element,attrs,ctrl){scope.$watch(attrs.webUploader,function(opts){opts&&loadScript("http://assets.haoyuyuan.com/vendor/plugins/igrow/webuploader/0.1.7/webuploader.igrow.min.js",function(){if(!WebUploader.Uploader.support()){alert("您的浏览器不支持上传功能！");throw new Error("WebUploader does not support the browser you are using.")}var resetInput=function(){$timeout(function(){var input=element.find("input[type=file]").first(),parent=input.parent(),keepclick=false;element.append(input);parent.remove();input.click(function(e){if(keepclick){e.stopPropagation();return false}keepclick=true;$timeout(function(){keepclick=false},1e3)})})};if(opts.WebUploader){opts.WebUploader.addButton({id:element});resetInput();return}var config={pick:{id:element,multiple:true,capture:"camera",configkey:"default_img"},accept:{extensions:"bmp,gif,jpg,jpeg,png"},auto:true,disableGlobalDnd:true,prepareNextFile:true,chunked:true,chunkRetry:0,threads:5,fileNumLimit:12,fileSingleSizeLimit:10*1024*1024,duplicate:true,thumb:{width:58,height:58,quality:80,allowMagnify:false,crop:true,type:"image/jpeg"},compress:{width:800,height:800,quality:80,allowMagnify:false,crop:false,preserveHeaders:true,noCompressIfLarger:false,compressSize:200*1024}};angular.forEach(config,function(value,key){if(angular.isObject(value)&&angular.isObject(this[key])){this[key]=angular.extend(value,this[key])}},opts.options=opts.options||{});config=angular.extend(config,opts.options);if(config.accept.extensions&&!config.accept.mimeTypes){config.accept.mimeTypes=getMimeTypes(config.accept.extensions)}if(WebUploader.os.android){delete config.pick.capture;config.compress.width=Math.min(config.compress.width,800);config.compress.height=Math.min(config.compress.height,800)}opts.WebUploader=WebUploader.create(config);angular.forEach(opts.events,function(fn,key){this.on(key,function(){var _this=this,_arguments=arguments;$timeout(function(){fn.apply(_this,_arguments)})})},opts.WebUploader);if(WebUploader.os.android){opts.WebUploader.on("startUpload",function(){viewMask.open()});opts.WebUploader.on("uploadFinished",function(){viewMask.close()})}resetInput()})})}}}]);app.directive("datetimepicker",["$parse","$q","$timeout","loadScript","loadStyle",function($parse,$q,$timeout,loadScript,loadStyle){return{restrict:"A",require:"?ngModel",link:function(scope,element,attrs,ctrl){var exist=!!$.fn.datetimepicker;$q.all([exist?null:loadScript(["http://assets.haoyuyuan.com/vendor/plugins/bootstrap/bootstrap-datetimepicker/2.0/js/bootstrap-datetimepicker.min.js","http://assets.haoyuyuan.com/vendor/plugins/bootstrap/bootstrap-datetimepicker/2.3.4/js/locales/bootstrap-datetimepicker.zh-CN.js"])]).then(function(){var component=element.parent().addClass("date"),picker=component.datetimepicker(angular.extend({autoclose:true,format:"yyyy-mm-dd",language:"zh-CN",pickerPosition:"bottom-left"},element.data()||{})).data("datetimepicker").picker;picker.find(".icon-arrow-left").replaceWith('<i class="icon-chevron-left"></i>');picker.find(".icon-arrow-right").replaceWith('<i class="icon-chevron-right"></i>');!function(isIphone){isIphone&&$(document).on("click touchstart",function(event){if($(event.target).closest(".datetimepicker").length===0){component.datetimepicker("hide")}});isIphone&&element.on("touchstart",function(event){component.datetimepicker("show");$(this).blur();return false})}(navigator.userAgent.match(/iPhone/i));attrs.eventInit&&$parse(attrs.eventInit,null,true)(scope,{$event:null});delete attrs.eventInit;angular.forEach(attrs,function(item,key,name){if(/^event/.test(key)){name=key.replace(/^event/,"").replace(/^\w/,function(v){return v.toLowerCase()});component.on(name,function(event){$timeout(function(){$parse(attrs[key],null,true)(scope,{$event:event})})})}})})}}}]);app.directive("modalConfirm",["$parse",function($parse){var dialog,$scope,$fn,$event,$confirm,$cancel;return{restrict:"A",link:function(scope,element,attrs,ctrl){if(!$("div[ng-view]>.modal-confirm").length){var tmpl=[];tmpl.push('<div class="modal modal-confirm">');tmpl.push('<div class="modal-dialog">');tmpl.push('<div class="modal-content">');tmpl.push('<div class="modal-body"></div>');tmpl.push('<div class="modal-footer">');tmpl.push('<button type="button" class="btn btn-danger">确定</button>');tmpl.push('<button type="button" class="btn btn-default">取消</button>');tmpl.push("</div>");tmpl.push("</div>");tmpl.push("</div>");tmpl.push("</div>");$("body>section>div[ng-view]").append(dialog=$(tmpl.join("")));dialog.find("button.btn-danger").click(function(event){$event=event;$fn=$confirm;dialog.modal("hide")});dialog.find("button.btn-default").click(function(event){$event=event;$fn=$cancel;dialog.modal("hide")});dialog.on("hidden.bs.modal",function(e){$event&&$scope.$apply(function(){$fn&&$fn($scope,{$event:$event});$event=null})})}element.click(function(event){$scope=scope;$confirm=attrs.modalConfirm&&$parse(attrs.modalConfirm);$cancel=attrs.modalCancel&&$parse(attrs.modalCancel);dialog.modal("show").find("div.modal-body").html("<b>"+(attrs.modalContent||"确认要删除吗？")+"</b>")})}}}]);app.directive("modalPreview",["$parse","$q","$rootScope","loadScript",function($parse,$q,$rootScope,loadScript){var dialog,$scope,$event,$remove,$ua=navigator.userAgent,showGroup=[];return{restrict:"A",link:function(scope,element,attrs,ctrl){$q.all([loadScript("http://assets.haoyuyuan.com/vendor/plugins/jquery/touchSwipe/1.6.9/jquery.touchSwipe.min.js")]).then(function(){if(!$("div[ng-view]>.modal-preview").length){var tmpl=[];tmpl.push('<div class="modal modal-preview">');tmpl.push('<div class="modal-dialog">');tmpl.push('<div class="modal-content">');tmpl.push('<div class="modal-body"></div>');tmpl.push('<div class="modal-footer">');tmpl.push('<a href="javascript:void(0)" class="glyphicon glyphicon-trash" data-dismiss="modal"></a>');tmpl.push("</div>");tmpl.push("</div>");tmpl.push("</div>");tmpl.push("</div>");$("body>section>div[ng-view]").append(dialog=$(tmpl.join("")));dialog.find(".glyphicon-trash").click(function(){if($remove){$scope.$apply(function(){$remove($scope,{$event:$event});$scope=null;$event=null})}else{$scope=null;$event=null}});dialog.find(".modal-body").swipe({swipe:function(event,direction,distance,duration,fingerCount,fingerData){console.log("event",event,"direction",direction,"distance",distance,"duration",duration,"fingerCount",fingerCount,"fingerData",fingerData)},pinchStatus:function(event,direction,distance,duration,fingerCount,zoom,fingerData){if(event.touches&&event.touches[0]&&event.touches[0].pageX&&event.touches[0].pageY){console.log("direction",direction,"pinchStatus",event,"pageX",event.touches[0].pageX,"pageY",event.touches[0].pageY)}else{console.log("direction",direction)}}})}element.click(function(event){dialog.find(".modal-body").html('<img src="/assets/img/public/loader.gif" />');if(attrs.modalPreview){$scope=scope;$event=event;if(attrs.modalRemove){$remove=$parse(attrs.modalRemove)}else{$remove=null}var imgData=$parse(attrs.modalPreview)($scope,{$event:$event});if(angular.isObject(imgData)){if(imgData.ready||imgData.progress)return;if(imgData.error){dialog.find(".modal-body").html('<img src="/assets/img/upload/loser.png" />');return}}else if(typeof imgData==="string"){imgData={url:imgData}}else{dialog.find(".modal-body").html('<img src="/assets/img/public/img-error.png" />');return}attrs.modalRemove?dialog.removeClass("onlyview"):dialog.addClass("onlyview");dialog.modal("show");var img=document.createElement("img");img.onload=function(){dialog.find(".modal-body").html(img)};img.onerror=function(){dialog.find(".modal-body").html('<img src="/assets/img/public/img-error.png" />')};img.src=imgData.url}})})}}}]);app.directive("clearIosShadow",[function(){return{restrict:"A",link:function(scope,element,attrs,ctrl){if(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/i.test(navigator.userAgent)){element.addClass("clear-ios-shadow")}}}}]);app.directive("loadUrl",[function(){return{restrict:"A",link:function(scope,element,attrs,ctrl){if(element[0].tagName==="IMG"){element.attr("src","/assets/img/public/loader.gif");if(attrs.loadUrl){var img=document.createElement("img");img.onload=function(){element.attr("src",this.src);img=null};img.onerror=function(){element.attr("src","/assets/img/public/img-error.png");img=null};img.src=attrs.loadUrl}}}}}]);app.directive("html5media",["$q","loadScript","loadStyle",function($q,loadScript,loadStyle){return{restrict:"E",link:function(scope,element,attrs,ctrl){return;$q.all([loadStyle("http://assets.haoyuyuan.com/vendor/plugins/video-js/4.12.7/video-js.min.css",true),loadScript("http://assets.haoyuyuan.com/vendor/plugins/video-js/4.12.7/"+(defaults.os.ios?"video.novtt.js":"video.js"))]).then(function(){if(!defaults.os.ios)videojs.options.flash.swf="http://assets.haoyuyuan.com/vendor/plugins/video-js/4.12.7/video-js.swf";if(/\.mp3$/i.test(attrs.src)){console.log("audio",attrs.src)}if(/(\.mp4|\.mov)$/i.test(attrs.src)){var width=element.parent().width(),type=mimetypes[attrs.src.match(/(\w+)$/gi)[0].toLowerCase()]||"video/mp4",elem=[];elem.push('<video class="video-js" width="'+width+'px" height="'+parseInt(width/16*9)+'px" controls preload="none" data-setup="{}">');elem.push('<source src="'+attrs.src+'" type="'+type+'" />');elem.push("</video>");element.replaceWith(elem.join(""))}})}}}]);app.directive("embed",[function(){return{restrict:"E",link:function(scope,element,attrs,ctrl){if(/^http\:\/\/player\.youku\.com/i.test(attrs.src)){var width=attrs.width||"100%",height=attrs.height||300,code=(/player\.php\/sid\/(.+)\/v.swf$/i.exec(attrs.src)||[])[1]||"";code&&element.replaceWith('<iframe width="'+width+'" height="'+height+'" src="http://player.youku.com/embed/'+code+'" frameborder="0" allowfullscreen></iframe>')}}}}]);app.directive("youkuAdRemove",["$timeout","loadScript",function($timeout,loadScript){return{restrict:"A",link:function(scope,element,attrs,ctrl){var renderMovie=function(data){$timeout(function(){var embed=element.find("embed"),img=element.find("img");embed.length&&angular.forEach(embed,function(item,index){if(/^http\:\/\/player\.youku\.com/i.test(item.src)){var code=(/player\.php\/sid\/(.+)\/v.swf$/i.exec(item.src)||[])[1]||"",width=attrs.width||"100%",height=attrs.height||250;code&&$(item).replaceWith('<iframe width="'+width+'" height="'+height+'" src="http://player.youku.com/embed/'+code+'" frameborder="0" allowfullscreen></iframe>')}});img.length&&angular.forEach(img,function(item){$(item).css("max-width","100%")})})};scope.$watch(attrs.youkuAdRemove,renderMovie)}}}]);app.controller(app.name+".controller",["$rootScope","$location","$route","$q","$api","routeApply","viewMask",function($rootScope,$location,$route,$q,$api,routeApply,viewMask){if(/^\/m\/school\/public\/\w\/\w\/\d/.test($location.url())){delete IGrow.User}if(!IGrow.User&&!/^\/m\/school|aboutSchool\/.+/.test($location.url())){$location.path("/m/"+defaults.redirect);$location.replace()}$api.$apply(angular.extend(defaults.service||{},{_m_role:["auth/user/role",,{check:{}}],_m_semester:["school/semester"],_m_school:["school"]}));$q.all([IGrow.User?$api._m_role.check({uid:IGrow.User.uid,rolecodes:defaults.app.schoolmanager}).$promise:null,IGrow.User?$api._m_semester.list({_orderby:"starttime desc"}).$promise:null,IGrow.User?$api._m_school.get().$promise:null]).then(function(result){result[0]&&result[0].data&&function(result){if(result.roles&&result.roles.length){IGrow.User.school.manager={};angular.forEach(result.roles,function(item){if(item=item.replace("school.","")){IGrow.User.school.manager[item]=true}})}}(result[0].data);result[1]&&result[1].data&&function(data){var before,after;angular.forEach(data,function(item){if(!IGrow.User.semesterData.current){if(item.status===1){IGrow.User.semesterData.current=item}if(item.status===2&&!before){before=item}if(item.status===0){after=item}}});if(!IGrow.User.semesterData.current&&(before||after)){IGrow.User.semesterData.current=before||after}IGrow.User.semesterid=IGrow.User.semesterData.current&&IGrow.User.semesterData.current.id||0}(IGrow.User.semesterData=result[1].data||[]);result[2]&&result[2].data&&function(result){IGrow.User.school=angular.extend(result||{},IGrow.User.school||{})}(result[2].data);setTimeout(function(){routeApply(defaults.map);$route.reload();$rootScope.$on("$routeChangeStart",function(event,next,current){document.title="";$("body>.modal-backdrop").remove();viewMask.open()});$rootScope.$on("$locationChangeStart",function(event,newUrl,oldUrl,newState,oldState){if(/\/main\//.test(newUrl)){event.preventDefault&&event.preventDefault();location.href=decodeURIComponent(newUrl)}});$rootScope.$on("$locationChangeSuccess",function(event,newUrl,oldUrl,newState,oldState){});$rootScope.$on("$routeChangeSuccess",function(event,current,previous){viewMask.close()})})})}]);angular.element(document).ready(function(){var rootCtrl=$(document.body).attr("ng-controller",app.name+".controller");IGrow.User&&rootCtrl.attr("class",IGrow.User.school.student?"m-app-student":"m-app-teacher");angular.bootstrap(document,[app.name])})})(angular.module("m.app",["ngResource","ngRoute","ngSanitize"]));